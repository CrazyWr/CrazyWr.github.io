<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>正则表达式 - 贪婪模式 回溯 | 面向信仰</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">正则表达式 - 贪婪模式 回溯</h1><a id="logo" href="/.">面向信仰</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> HOME</i></a><a href="/archives/"><i class="fa fa-archive"> ARCHIVE</i></a><a href="/about/"><i class="fa fa-user"> ABOUT</i></a><a href="/book/"><i class="fa fa-book"> BOOK</i></a><a href="/wiki/"><i class="fa fa-list"> WIKI</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">正则表达式 - 贪婪模式 回溯</h1><div class="post-meta">Dec 4, 2017<span> | </span><span class="category"><a href="/categories/tech/">tech</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4,121</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 15</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#贪婪模式与非贪婪模式"><span class="toc-text">贪婪模式与非贪婪模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#贪婪匹配模式"><span class="toc-text">贪婪匹配模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#标识符"><span class="toc-text">标识符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#示例"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#非贪婪匹配模式"><span class="toc-text">非贪婪匹配模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#定义-1"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#标识符-1"><span class="toc-text">标识符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#示例-1"><span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例练习"><span class="toc-text">实例练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#回溯现象与匹配失败"><span class="toc-text">回溯现象与匹配失败</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#回溯现象"><span class="toc-text">回溯现象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#贪婪匹配过程分析"><span class="toc-text">贪婪匹配过程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#非贪婪匹配表达式"><span class="toc-text">非贪婪匹配表达式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结-1"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#非贪婪匹配的效率"><span class="toc-text">非贪婪匹配的效率</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#效率陷阱的产生："><span class="toc-text">效率陷阱的产生：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#效率陷阱的避免："><span class="toc-text">效率陷阱的避免：</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>本篇为转载:<br>作者：撒网要见鱼<br>链接：<a href="http://www.jianshu.com/p/a641aab7ee97" target="_blank" rel="external">http://www.jianshu.com/p/a641aab7ee97</a></p>
<h2 id="贪婪模式与非贪婪模式"><a href="#贪婪模式与非贪婪模式" class="headerlink" title="贪婪模式与非贪婪模式"></a>贪婪模式与非贪婪模式</h2><h3 id="贪婪匹配模式"><a href="#贪婪匹配模式" class="headerlink" title="贪婪匹配模式"></a>贪婪匹配模式</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>正则表达式去匹配时，会尽量多的匹配符合条件的内容</p>
<h4 id="标识符"><a href="#标识符" class="headerlink" title="标识符"></a>标识符</h4><p>+，?，*，{n}，{n,}，{n,m}</p>
<p>匹配时，如果遇到上述标识符，代表是贪婪匹配，会尽可能多的去匹配内容</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> str='aacbacbc';</div><div class="line"><span class="keyword">var</span> <span class="keyword">reg</span>=/a.*b/;</div><div class="line"><span class="keyword">var</span> res=str.<span class="built_in">match</span>(<span class="keyword">reg</span>);</div><div class="line"></div><div class="line"><span class="comment">// aacbacb index为0</span></div><div class="line">console.<span class="built_in">log</span>(res);</div></pre></td></tr></table></figure>
<p>上例中，匹配到第一个a后，开始匹配.*，由于是贪婪模式，它会一直往后匹配，直到最后一个满足条件的b为止，因此匹配结果是aacbacb</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> str='aacbacbc';</div><div class="line"><span class="keyword">var</span> <span class="keyword">reg</span>=/<span class="keyword">ac</span>.*b/;</div><div class="line"><span class="keyword">var</span> res=str.<span class="built_in">match</span>(<span class="keyword">reg</span>);</div><div class="line"></div><div class="line"><span class="comment">// acbacb index为1</span></div><div class="line">console.<span class="built_in">log</span>(res);</div></pre></td></tr></table></figure>
<p>第一个匹配的是a，然后再匹配下一个字符a时，和正则不匹配，因此匹配失败，index挪到1，接下来匹配成功了ac，继续往下匹配，由于是贪婪模式，尽可能多的去匹配结果，直到最后一个符合要求的b为止，因此匹配结果是acbacb</p>
<h3 id="非贪婪匹配模式"><a href="#非贪婪匹配模式" class="headerlink" title="非贪婪匹配模式"></a>非贪婪匹配模式</h3><h4 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4><p>正则表达式去匹配时，会尽量少的匹配符合条件的内容<br>也就是说，一旦发现匹配符合要求，立马就匹配成功，而不会继续匹配下去(除非有g，开启下一组匹配)</p>
<h4 id="标识符-1"><a href="#标识符-1" class="headerlink" title="标识符"></a>标识符</h4><p>+?，??，*?，{n}?，{n,}?，{n,m}?</p>
<p>可以看到，非贪婪模式的标识符很有规律，就是贪婪模式的标识符后面加上一个?</p>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> str='aacbacbc';</div><div class="line"><span class="keyword">var</span> <span class="keyword">reg</span>=/a.*?b/;</div><div class="line"><span class="keyword">var</span> res=str.<span class="built_in">match</span>(<span class="keyword">reg</span>);</div><div class="line"></div><div class="line"><span class="comment">// aacb index为0</span></div><div class="line">console.<span class="built_in">log</span>(res);</div></pre></td></tr></table></figure>
<p>上例中，匹配到第一个a后，开始匹配.*?，由于是非贪婪模式，它在匹配到了第一个b后，就匹配成功了，因此匹配结果是aacb</p>
<p>为什么是aacb而不是acb呢？<br>因为前面有提到过一个正在匹配的优先规则: 最先开始的匹配拥有最高的优先权<br>第一个a匹配到了，只要之后没有发生匹配失败的情况，它就会一直匹配下去，直到匹配成功</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> str='aacbacbc';</div><div class="line"><span class="keyword">var</span> <span class="keyword">reg</span>=/<span class="keyword">ac</span>.*?b/;</div><div class="line"><span class="keyword">var</span> res=str.<span class="built_in">match</span>(<span class="keyword">reg</span>);</div><div class="line"></div><div class="line"><span class="comment">// acb index为1</span></div><div class="line">console.<span class="built_in">log</span>(res);</div></pre></td></tr></table></figure>
<p>先匹配的a，接下来匹配第二个a时，匹配失败了index变为1，继续匹配ac成功，继续匹配b，由于是非贪婪模式，此时acb已经满足了正则的最低要求了，因此匹配成功，结果为acb</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> str='aacbacbc';</div><div class="line"><span class="keyword">var</span> <span class="keyword">reg</span>=/a.*?/;</div><div class="line"><span class="keyword">var</span> res=str.<span class="built_in">match</span>(<span class="keyword">reg</span>);</div><div class="line"></div><div class="line"><span class="comment">// a index为0</span></div><div class="line">console.<span class="built_in">log</span>(res);</div><div class="line"></div><div class="line"><span class="keyword">var</span> reg2=/a.*/;</div><div class="line"><span class="keyword">var</span> res2=str.<span class="built_in">match</span>(reg2);</div><div class="line"></div><div class="line"><span class="comment">// aacbacbc index为0</span></div><div class="line">console.<span class="built_in">log</span>(res2);</div></pre></td></tr></table></figure>
<p>这一个例子则是对示例1的补充，可以发现，当后面没有b时，由于是非贪婪模式，匹配到第一个a就直接匹配成功了<br>而后面一个贪婪模式的匹配则是会匹配所有</p>
<h3 id="实例练习"><a href="#实例练习" class="headerlink" title="实例练习"></a>实例练习</h3><p>在初步理解了贪婪模式与非贪婪模式后，可以通过练习加深理解</p>
<ul>
<li>提取HTML中的Div标签</li>
</ul>
<p>给出一个HTML字符串，如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>用户:<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>张三<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>密码:<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>123456<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<p>需求: 提取出div包裹的内容(包括div标签本身)，并将各个结果存入数组</p>
<p>代码: 通过非贪婪模式的全局匹配来完成，如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">var reg=/<span class="tag">&lt;<span class="name">div</span>&gt;</span>.*?<span class="tag">&lt;<span class="name">\</span>/<span class="attr">div</span>&gt;</span>/g;</div><div class="line">var res=str.match(reg);</div><div class="line"></div><div class="line">// ["<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>用户:<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>张三<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>", "<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>密码:<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>123456<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>"]</div><div class="line">console.log(res);</div></pre></td></tr></table></figure>
<p>详解: 用到了两个知识点，<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">.\*?的非贪婪模式匹配以及g全局匹配</div><div class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>.\*?<span class="tag">&lt;<span class="name">\</span>/<span class="attr">div</span>&gt;</span>代表每次只会匹配一次div，这样可以确保每一个div不会越界</div><div class="line"></div><div class="line">最后的g代表全局匹配，即第一次匹配成功后，会将匹配结果放入数组，然后从下一个index重新开始匹配新的结果</div><div class="line"></div><div class="line">另外: 假设使用了/<span class="tag">&lt;<span class="name">div</span>&gt;</span>.\*<span class="tag">&lt;<span class="name">\</span>/<span class="attr">div</span>&gt;</span>/g进行贪婪模式的匹配，结果则是</div><div class="line"></div><div class="line">\["<span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>用户:<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>张三<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>密码:<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>123456<span class="tag">&lt;<span class="name">span</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>"]</div><div class="line">因为贪婪模式匹配了第一个<span class="tag">&lt;<span class="name">div</span>&gt;</span>后会无限贪婪的匹配接下来的字符，直到最后一个符合条件的<span class="tag">&lt;/<span class="name">div</span>&gt;</span>为止，导致了将中间所有的div标签都一起匹配上了</div></pre></td></tr></table></figure></p>
<ul>
<li>提取两个””中的子串，其中不能再包含””<br>示例引用自: 正则表达式之 贪婪与非贪婪模式详解(<a href="http://www.jb51.net/article/31491.htm" target="_blank" rel="external">http://www.jb51.net/article/31491.htm</a>)<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"The phrase <span class="subst">\"</span>regular expression<span class="subst">\"</span> is called <span class="subst">\"</span>Regex<span class="subst">\"</span> for short"</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>需求: 提取两个引号之间的子串，其中不能再包括引号，例如上述的提取结果应该是: “regular expression” 与 “Regex”(每一个结束的”后面都接空格)<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">错误解法: 通过如下的非贪婪匹配(请注意空格)</div><div class="line"></div><div class="line"><span class="keyword">var</span> str='<span class="string">"The phrase \"</span>regular expression\<span class="string">" is called \"</span>Regex\<span class="string">" for short"</span>';</div><div class="line"><span class="keyword">var</span> <span class="keyword">reg</span>=/<span class="string">".\*?"</span> /<span class="keyword">g</span>;</div><div class="line"><span class="keyword">var</span> res=str.<span class="built_in">match</span>(<span class="keyword">reg</span>);</div><div class="line"></div><div class="line"><span class="comment">// \['"The phrase "regular expression"  ', '"Regex"  ']</span></div><div class="line">console.<span class="built_in">log</span>(res);</div></pre></td></tr></table></figure></p>
<p>可以看到，上述的匹配完全就是匹配错误了，这个正则匹配到第一个符合条件的”+空格后就自动停下来了</p>
<p>正确解法: 使用贪婪模式进行匹配<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> <span class="keyword">reg</span>=/<span class="string">"\[^"</span>]\*" /<span class="keyword">g</span>;</div><div class="line"><span class="keyword">var</span> res=str.<span class="built_in">match</span>(<span class="keyword">reg</span>);</div><div class="line"></div><div class="line"><span class="comment">// \['"regular expression" ', '"Regex" ']</span></div><div class="line">console.<span class="built_in">log</span>(res);</div></pre></td></tr></table></figure></p>
<p>这个匹配中</p>
<p>从第一个”开始匹配，接下来到12位时(“r的”)，不满足{FNXX==XXFN}，也不满足之后的”+空格，因此匹配失败了，index挪到下一个，开始下一次匹配</p>
<p>第二个匹配从”r的”开始，一直匹配到n”空格的空格，这一组刚刚好匹配成功(因为最后符合了正则的”空格)，匹配好了”regular expression”空格</p>
<p>第三个匹配匹配到了”Regex”空格(过程不再复述)</p>
<p>到最后时，仅剩一个”直接匹配失败(因为首先得符合”才能开始挣扎匹配)</p>
<p>至此，正则匹配结束，匹配成功，并且符合预期</p>
<p>最后: 这个例子相对来说复杂一点，如要更好的理解，可以参考引用来源中的文章，里面有就原理进行介绍<br>另外，参考文章中还有对非贪婪模式的匹配失败，回溯影响性能等特性进行原理分析与讲解</p>
<h2 id="回溯现象与匹配失败"><a href="#回溯现象与匹配失败" class="headerlink" title="回溯现象与匹配失败"></a>回溯现象与匹配失败</h2><p>你真的已经理解了贪婪模式和非贪婪模式么？</p>
<h3 id="回溯现象"><a href="#回溯现象" class="headerlink" title="回溯现象"></a>回溯现象</h3><p>不知道对上面最后例子中提到的回溯这词有没有概念？<br>这里仍然以上例引用来源中的示例来分析</p>
<p>原字符串</p>
<p>“Regex”</p>
<h4 id="贪婪匹配过程分析"><a href="#贪婪匹配过程分析" class="headerlink" title="贪婪匹配过程分析"></a>贪婪匹配过程分析</h4><p>“.*“<br>第一个”取得控制权，匹配正则中的”，匹配成功，控制权交给.*</p>
<p>.<em>取得控制权后，匹配接下来的字符，.代表匹配任何字符，</em>代表可匹配可不匹配，这属于贪婪模式的标识符，会优先尝试匹配，于是接下来从1位置处的R开始匹配，依次成功匹配了R，e，g，e，x，接着继续匹配最后一个字符”，匹配成功，这时候已经匹配到了字符串的结尾，所以.*匹配结束，将控制符交给正则式中最后的”</p>
<p>“取得控制权后，由于已经是到了字符串的结尾，因此匹配失败，向前查找可供回溯的状态，控制权交给.<em>，.</em>让出一个字符”，再把控制权交给”，此时刚好匹配成功</p>
<p>至此，整个正则表达式匹配完毕，匹配结果为”Regex”，匹配过程中回溯了1次</p>
<h4 id="非贪婪匹配表达式"><a href="#非贪婪匹配表达式" class="headerlink" title="非贪婪匹配表达式"></a>非贪婪匹配表达式</h4><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">".\*?"</span></div></pre></td></tr></table></figure>
<p>第一个”取得控制权，匹配正则中的”，匹配成功，控制权交给.*?</p>
<p>.*?取得控制权后，由于这是非贪婪模式下的标识符，因此在可匹配可不匹配的情况下会优先不匹配，因此尝试不匹配任何内容，将控制权交给”，此时index在1处(R字符处)</p>
<p>“取得控制权后，开始匹配1处的R，匹配失败，向前查找可供回溯的状态，控制权交给.<em>?，.</em>?吃进一个字符，index到了2处，再把控制权交给”</p>
<p>“取得控制权后，开始匹配2处的e，匹配失败，重复上述的回溯过程，直到.*?吃进了x字符，再将控制权交给”</p>
<p>“取得控制权后，开始匹配6处的”，匹配成功</p>
<p>至此，整个正则表达式匹配完毕，匹配结果为”Regex”，匹配过程中回溯了5次</p>
<p>优化去除回溯</p>
<p>上述的贪婪匹配中，出现了一次回溯现象，其实也可以通过优化表达式来防止回溯的，比如<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"\[^"</span>]\*<span class="string">"</span></div></pre></td></tr></table></figure></p>
<p>这个表达式中构建了一个子表达式-<a href=""></a>中的^”，它的作用是排除”匹配，这样*的贪婪匹配就不会主动吃进”，这样最后就直接是”匹配”，匹配成功，不会进行回溯</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>上述的分析中可以看出，在匹配成功的情况下，贪婪模式进行了更少的回溯(可以自行通过更多的实验进行验证)，因此在应用中，在对正则掌握不是很精通的情况下，可以优先考虑贪婪模式的匹配，这样可以避免很多性能上的问题</p>
<p>匹配失败的情况</p>
<p>上述的回溯分析都是基于匹配成功的情况，那如果是匹配失败呢？<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">var</span> str = <span class="string">'"Regex'</span></div><div class="line"><span class="selector-tag">var</span> reg = /<span class="string">"\[^"</span>]\*<span class="string">"/g;</span></div></pre></td></tr></table></figure></p>
<p>这个原字符中，没有最后的”，因此匹配是会失败的，它的过程大致如下</p>
<p>“匹配”，接着<a href=""></a>的^”与*匹配R，e，g，e，x</p>
<p>接着到了最后，”获取控制权，由于到了最后，开始回溯</p>
<p>依次回溯的结果是<em>让出x，e，g，e，R，直到</em>已经无法再让出字符，第一轮匹配失败</p>
<p>接着index开始往下挪，依次用”匹配R，e，g，e，x都失败了，一直到最后也没有再匹配到结果，因此此次正则表达式的匹配失败，没有匹配到结果(或者返回null)</p>
<p>那非贪婪模式呢？<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/<span class="string">"\[^"</span>]\*?<span class="string">"/g</span></div></pre></td></tr></table></figure></p>
<p>“匹配”，接着<em>尝试不匹配，”匹配R，失败，然后回溯，</em>吃进R</p>
<p>接下来类似于上一步，<em>依次回溯吃进e，g，e，x，一直到最后，</em>再次回溯想吃进时，已经到了字符串结尾了，无法继续，因此第一轮匹配失败</p>
<p>接着index开始往下挪，依次用”匹配R，e，g，e，x都失败了，返回null</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>通过匹配失败的例子可以看出贪婪和非贪婪的模式区别。贪婪是先吃进，回溯再让出，非贪婪是先忽略，回溯再吃进</p>
<p>而且，在匹配失败的情况下，贪婪模式也会进行不少的回溯(非贪婪当然一直都很多回溯)</p>
<p>但是，实际情况中是可以通过子表达式优化的，比如构建^xxx，可以当匹配到不符合条件的时候提前匹配失败，这样就会少很多回溯<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">var</span> str = <span class="string">'"cccccc'</span></div><div class="line"><span class="selector-tag">var</span> reg = /<span class="string">"\[^"</span>c]\*<span class="string">"/g;</span></div></pre></td></tr></table></figure></p>
<p>这个由于直接排除了c，因此*不会吃进它，直接就匹配失败了，减少了很多回溯(当然，上述只是最简单的例子，实际情况要更复杂)</p>
<h3 id="非贪婪匹配的效率"><a href="#非贪婪匹配的效率" class="headerlink" title="非贪婪匹配的效率"></a>非贪婪匹配的效率</h3><figure class="highlight bnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">可能有不少的人和我一样，有过这样的经历：当我们要匹配类似 "<span class="attribute">&lt;td&gt;</span>内容<span class="attribute">&lt;/td&gt;</span>" 或者 "[b]加粗[/b]" 这样的文本时，我们根据正向预搜索功能写出这样的表达式："<span class="attribute">&lt;td&gt;</span>([^<span class="attribute">&lt;]|&lt;(?!/td&gt;</span>))*<span class="attribute">&lt;/td&gt;</span>" 或者 "<span class="attribute">&lt;td&gt;</span>((?!<span class="attribute">&lt;/td&gt;</span>).)*<span class="attribute">&lt;/td&gt;</span>"。</div><div class="line"></div><div class="line">当发现非贪婪匹配之时，恍然大悟，同样功能的表达式可以写得如此简单："<span class="attribute">&lt;td&gt;</span>.*?<span class="attribute">&lt;/td&gt;</span>"。 顿时间如获至宝，凡是按边界匹配的地方，尽量使用简捷的非贪婪匹配 ".*?"。特别是对于复杂的表达式来说，采用非贪婪匹配 ".*?" 写出来的表达式的确是简练了许多。</div><div class="line"></div><div class="line">然而，当一个表达式中，有多个非贪婪匹配时，或者多个未知匹配次数的表达式时，这个表达式将可能存在效率上的陷阱。有时候，匹配速度慢得莫名奇妙，甚至开始怀疑正则表达式是否实用。</div></pre></td></tr></table></figure>
<h4 id="效率陷阱的产生："><a href="#效率陷阱的产生：" class="headerlink" title="效率陷阱的产生："></a>效率陷阱的产生：</h4><p>  在本站基础文章里，对非贪婪匹配的描述中说到：“如果少匹配就会导致整个表达式匹配失败的时候，与贪婪模式类似，非贪婪模式会最小限度的再匹配一些，以使整个表达式匹配成功。”</p>
<p>  具体的匹配过程是这样的：</p>
<p>  “非贪婪部分” 先匹配最少次数，然后尝试匹配 “右侧的表达式”。<br>  如果右侧的表达式匹配成功，则整个表达式匹配结束。如果右侧表达式匹配失败，则 “非贪婪部分” 将增加匹配一次，然后再尝试匹配 “右侧的表达式”。<br>  如果右侧的表达式又匹配失败，则 “非贪婪部分” 将再增加匹配一次。再尝试匹配 “右侧的表达式”。<br>  依此类推，最后得到的结果是 “非贪婪部分” 以尽可能少的匹配次数，使整个表达式匹配成功。或者最终仍然匹配失败。<br>  当一个表达式中有多个非贪婪匹配，以表达式 “d(\w+?)d(\w+?)z” 为例，对于第一个括号中的 “\w+?” 来说，右边的 “d(\w+?)z” 属于它的 “右侧的表达式”，对于第二个括号中的 “\w+?” 来说，右边的 “z” 属于它的 “右侧的表达式”。</p>
<p>  当 “z” 匹配失败时，第二个 “\w+?” 会 “增加匹配一次”，再尝试匹配 “z”。如果第二个 “\w+?” 无论怎样 “增加匹配次数”，直至整篇文本结束，”z” 都不能匹配，那么表示 “d(\w+?)z” 匹配失败，也就是说第一个 “\w+?” 的 “右侧” 匹配失败。此时，第一个 “\w+?” 会增加匹配一次，然后再进行 “d(\w+?)z” 的匹配。循环前面所讲的过程，直至第一个 “\w+?” 无论怎么 “增加匹配次数”，后边的 “d(\w+?)z” 都不能匹配时，整个表达式才宣告匹配失败。</p>
<p>  其实，为了使整个表达式匹配成功，贪婪匹配也会适当的“让出”已经匹配的字符。因此贪婪匹配也有类似的情况。当一个表达式中有较多的未知匹配次数的表达式时，为了让整个表达式匹配成功，各个贪婪或非贪婪的表达式都要进行尝试减少或增加匹配次数，由此容易形成一个大循环的尝试，造成了很长的匹配时间。本文之所以称之为“陷阱”，因为这种效率问题往往不易察觉。</p>
<p>  举例：”d(\w+?)d(\w+?)d(\w+?)z” 匹配 “ddddddddddd…” 时，将花费较长一段时间才能判断出匹配失败 。</p>
<h4 id="效率陷阱的避免："><a href="#效率陷阱的避免：" class="headerlink" title="效率陷阱的避免："></a>效率陷阱的避免：</h4><p>  避免效率陷阱的原则是：避免“多重循环”的“尝试匹配”。并不是说非贪婪匹配就是不好的，只是在运用非贪婪匹配的时候，需要注意避免过多“循环尝试”的问题。<br><figure class="highlight django"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="xml">情况一：对于只有一个非贪婪或者贪婪匹配的表达式来说，不存在效率陷阱。也就是说，要匹配类似 "<span class="tag">&lt;<span class="name">td</span>&gt;</span> 内容 <span class="tag">&lt;/<span class="name">td</span>&gt;</span>" 这样的文本，表达式 "<span class="tag">&lt;<span class="name">td</span>&gt;</span>([^<span class="tag">&lt;<span class="name">]|</span>&lt;(?!/<span class="attr">td</span>&gt;</span>))*<span class="tag">&lt;/<span class="name">td</span>&gt;</span>" 和 "<span class="tag">&lt;<span class="name">td</span>&gt;</span>((?!<span class="tag">&lt;/<span class="name">td</span>&gt;</span>).)*<span class="tag">&lt;/<span class="name">td</span>&gt;</span>" 和 "<span class="tag">&lt;<span class="name">td</span>&gt;</span>.*?<span class="tag">&lt;/<span class="name">td</span>&gt;</span>" 的效率是完全相同的。</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml">情况二：如果一个表达式中有多个未知匹配次数的表达式，应防止进行不必要的尝试匹配。</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml">比如，对表达式 "<span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'(.*?)'</span>&gt;</span><span class="undefined">(.*?)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>" 来说， 如果前面部分表达式在遇到 "<span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'vbscript'</span>&gt;</span><span class="actionscript"><span class="string">" 时匹配成功后，而后边的 "</span>(.*?)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>" 却匹配失败，将导致第一个 ".*?" 增加匹配次数再尝试。而对于表达式真正目的，让第一个 ".*?" 增加匹配成“vbscript'&gt;”是不对的，因此这种尝试是不必要的尝试。</span></div><div class="line"><span class="xml"></span></div><div class="line"><span class="xml">因此，对依靠边界来识别的表达式，不要让未知匹配次数的部分跨过它的边界。前面的表达式中，第一个 ".*?" 应该改写成 "[^']*"。后边那个 ".*?" 的右边再没有未知匹配次数的表达式，因此这个非贪婪匹配没有效率陷阱。于是，这个匹配脚本块的表达式，应该写成："<span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">'([^'</span>]*)'&gt;</span><span class="undefined">(.*?)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>" 更好。</span></div></pre></td></tr></table></figure></p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>BummingBoy</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2017/12/04/正则表达式 - 贪婪模式 回溯/">https://bummingboy.top/2017/12/04/正则表达式 - 贪婪模式 回溯/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>BummingBoy</li></ul></div><br><br><div class="tags"><a href="/tags/regex/">RegEx</a></div><div class="post-nav"><a class="pre" href="/2017/12/19/shell - 参数解析三种方式(手工, getopts, getopt)/">shell - 参数解析三种方式(手工, getopts, getopt)</a><a class="next" href="/2017/12/04/Centos7 安装 Docker Private Registry 和 Web UI/">Centos 7 安装 Docker Private Registry 和 Web UI</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/chrome/">Chrome</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">JavaScript</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">Linux</a><span class="category-list-count">12</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/centos-7/">Centos 7</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">Mac</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">Network</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">Node</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ios/">iOS</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">tech</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/tuxera/" style="font-size: 15px;">Tuxera</a> <a href="/tags/centos7/" style="font-size: 15px;">Centos7</a> <a href="/tags/nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/linux/" style="font-size: 15px;">Linux</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/centos-7/" style="font-size: 15px;">Centos 7</a> <a href="/tags/python3/" style="font-size: 15px;">Python3</a> <a href="/tags/nodejs/" style="font-size: 15px;">Nodejs</a> <a href="/tags/docker/" style="font-size: 15px;">Docker</a> <a href="/tags/private-registry/" style="font-size: 15px;">private registry</a> <a href="/tags/chrome/" style="font-size: 15px;">Chrome</a> <a href="/tags/http/" style="font-size: 15px;">HTTP</a> <a href="/tags/长连接/" style="font-size: 15px;">长连接</a> <a href="/tags/短连接/" style="font-size: 15px;">短连接</a> <a href="/tags/javascript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/类型比较/" style="font-size: 15px;">类型比较</a> <a href="/tags/css/" style="font-size: 15px;">CSS</a> <a href="/tags/系统时间/" style="font-size: 15px;">系统时间</a> <a href="/tags/react/" style="font-size: 15px;">React</a> <a href="/tags/this/" style="font-size: 15px;">this</a> <a href="/tags/node/" style="font-size: 15px;">Node</a> <a href="/tags/浮点数/" style="font-size: 15px;">浮点数</a> <a href="/tags/mac/" style="font-size: 15px;">Mac</a> <a href="/tags/任何来源/" style="font-size: 15px;">任何来源</a> <a href="/tags/mongodb/" style="font-size: 15px;">MongoDB</a> <a href="/tags/gitlab/" style="font-size: 15px;">Gitlab</a> <a href="/tags/ntfs/" style="font-size: 15px;">NTFS</a> <a href="/tags/pm2/" style="font-size: 15px;">pm2</a> <a href="/tags/cluster/" style="font-size: 15px;">cluster</a> <a href="/tags/sketch-缓存/" style="font-size: 15px;">sketch 缓存</a> <a href="/tags/firewall/" style="font-size: 15px;">firewall</a> <a href="/tags/ios/" style="font-size: 15px;">iOS</a> <a href="/tags/崩溃日志/" style="font-size: 15px;">崩溃日志</a> <a href="/tags/commonjs/" style="font-size: 15px;">CommonJS</a> <a href="/tags/es6/" style="font-size: 15px;">ES6</a> <a href="/tags/import-export/" style="font-size: 15px;">import/export</a> <a href="/tags/du/" style="font-size: 15px;">du</a> <a href="/tags/沙盒路径/" style="font-size: 15px;">沙盒路径</a> <a href="/tags/mysql/" style="font-size: 15px;">MySQL</a> <a href="/tags/layers-of-ios/" style="font-size: 15px;">Layers of iOS</a> <a href="/tags/cocoa-touch/" style="font-size: 15px;">Cocoa Touch</a> <a href="/tags/绘图/" style="font-size: 15px;">绘图</a> <a href="/tags/core-graphics-quartz-2d/" style="font-size: 15px;">Core Graphics/QuartZ 2D</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/私有仓库/" style="font-size: 15px;">私有仓库</a> <a href="/tags/if/" style="font-size: 15px;">if</a> <a href="/tags/yum/" style="font-size: 15px;">yum</a> <a href="/tags/正则表达式/" style="font-size: 15px;">正则表达式</a> <a href="/tags/regex/" style="font-size: 15px;">RegEx</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">面向信仰.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/async_load_bg_image.js" async> </script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>